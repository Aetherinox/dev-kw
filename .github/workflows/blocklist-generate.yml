# #
#   @usage              https://github.com/Aetherinox/csf-firewall
#   @type               github workflow
#   
#   used in combination with .github/scripts/bl-download.sh
#
#   download AbuseIPDB ip list after list of ips are downloaded, merges them with a static list
#   that is not updated as often which contains a list of long-term abusive ip addresses
#   
#   local test requires the same structure as the github workflow
#       ðŸ“ .github
#           ðŸ“ blocks
#               ðŸ“ bruteforce
#                   ðŸ“„ 01.ipset
#               ðŸ“ privacy
#                   ðŸ“„ 01.ipset
#           ðŸ“ scripts
#               ðŸ“„ bl-download.sh
#               ðŸ“„ bl-htmltext.sh
#               ðŸ“„ bl-json.sh
#               ðŸ“„ bl-master.sh
#               ðŸ“„ bl-static.sh
#           ðŸ“ workflows
#               ðŸ“„ blocklist-generate.yml
# #

name: "ðŸ§± Blocklist â€º Generate"
run-name: "ðŸ§± Blocklist â€º Generate"

# #
#   triggers
# #

on:
    workflow_dispatch:

    schedule:
        - cron: '0 0,6,12,18 * * *'
        - cron: '0 2 * * *'

# #
#   environment variables
# #

env:
    BOT_NAME_1:           EuropaServ
    BOT_NAME_DEPENDABOT:  dependabot[bot]

# #
#   jobs
# #

jobs:

    # #
    #   Job > Setup
    # #

    blocklist-setup:
        name: >-
          ðŸ“¦ Setup
        runs-on: apollo-x64
        steps:

            - name: "âœ… Start"
              id: task_setup_start
              run: |
                echo "Starting blocklist build script"

            # #
            #   Job > Checkout
            # #

            - name: "â˜‘ï¸ Checkout"
              id: task_setup_checkout
              uses: actions/checkout@v4
              with:
                fetch-depth: 0

            # #
            #   Generate > Install Packages
            # #

            - name: "ðŸ§± Install Packages"
              id: task_setup_install
              run: |
                  sudo apt-get install -y ipcalc
                  sudo apt-get install -y ed
                  sudo apt-get install -y html2text
                  sudo apt-get install -y whois
                  sudo apt-get install -y uuid-runtime

    # #
    #   Job > Blocklist > Master
    # #

    blocklist-generate:
        name: >-
          ðŸ“‹ Generate â€º Blocklist
        runs-on: apollo-x64
        needs: [ blocklist-setup ]
        steps:

            # #
            #   Generate > Checkout
            # #

            - name: "â˜‘ï¸ Checkout"
              id: task_blocklist_generate_checkout
              uses: actions/checkout@v4
              with:
                fetch-depth: 0

            # #
            #   Generate > Set Template Permissions
            # #

            - name: "â˜‘ï¸ Set Permissions"
              id: task_blocklist_generate_perms
              run: |

                  #   Set Permissions
                  chmod +x ".github/scripts/bl-master.sh"
                  chmod +x ".github/scripts/bl-template.sh"
                  chmod +x ".github/scripts/bl-htmltext.sh"
                  chmod +x ".github/scripts/bl-static.sh"
                  chmod +x ".github/scripts/bl-json.sh"
                  chmod +x ".github/scripts/bl-download.sh"

            # #
            #   Generate > Set Env Variables
            # #

            - name: "ðŸ“¦ Set Env Variables"
              id: task_commit_pre
              run: |
                  useragent="Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36"
                  echo "USERAGENT=$(echo $useragent)" >> $GITHUB_ENV

            # #
            #   Generate > Master
            # #

            - name: "ðŸ§± Generate â€º Master"
              id: task_blocklist_generate_master
              run: |
                  run_master=".github/scripts/bl-master.sh ${{ vars.API_01_OUT }} false ${{ secrets.API_01_FILE_01 }} ${{ secrets.API_01_FILE_02 }} ${{ secrets.API_01_FILE_03 }} ${{ secrets.API_01_FILE_04 }} ${{ secrets.API_01_FILE_05 }} ${{ secrets.API_01_FILE_06 }} ${{ secrets.API_01_FILE_07 }} ${{ secrets.API_01_FILE_08 }}"
                  eval "./$run_master"

                  run_highrisk=".github/scripts/bl-htmltext.sh ${{ vars.API_01_HIGHRISK_OUT }} ${{ secrets.API_01_HIGHRISK_URL }} '[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}'"
                  eval "./$run_highrisk"

            # #
            #   Generate > Privacy
            # #

            - name: "ðŸ§± Generate â€º Privacy"
              id: task_blocklist_generate_privacy
              run: |

                  #   Privacy â€º General
                  run_general=".github/scripts/bl-static.sh ${{ vars.API_02_GENERAL_OUT }} privacy"
                  eval "./$run_general"

                  #   Privacy â€º Google
                  run_google=".github/scripts/bl-json.sh ${{ vars.API_02_GOOGLE_OUT }} https://developers.google.com/search/apis/ipranges/googlebot.json '.prefixes | .[] |.ipv4Prefix//empty,.ipv6Prefix//empty'"
                  eval "./$run_google"

                  #   Privacy â€º Cloudfront
                  run_cloudfront=".github/scripts/bl-json.sh ${{ vars.API_02_CLOUDFRONT_OUT }} https://d7uri8nf7uskq.cloudfront.net/tools/list-cloudfront-ips 'map(.[]) | sort | .[]'"
                  eval "./$run_cloudfront"

                  #   Privacy â€º Bing
                  run_bing=".github/scripts/bl-json.sh ${{ vars.API_02_BING_OUT }} https://bing.com/toolbox/bingbot.json '.prefixes | .[] |.ipv4Prefix//empty,.ipv6Prefix//empty'"
                  eval "./$run_bing"
                
                  #   Privacy â€º Fastly
                  run_fastly=".github/scripts/bl-json.sh ${{ vars.API_02_FASTLY_OUT }} https://api.fastly.com/public-ip-list 'map(.[]) | .[]'"
                  eval "./$run_fastly"

                  #   Privacy â€º Amazon AWS
                  run_amz_aws=".github/scripts/bl-json.sh ${{ vars.API_02_AMAZON_AWS_OUT }} https://ip-ranges.amazonaws.com/ip-ranges.json '.prefixes[] | select(.service==\"AMAZON\") | .ip_prefix'"
                  eval "./$run_amz_aws"

                  #   Privacy â€º Amazon EC2
                  run_amz_ec2=".github/scripts/bl-json.sh ${{ vars.API_02_AMAZON_EC2_OUT }} https://ip-ranges.amazonaws.com/ip-ranges.json '.prefixes[] | select(.service==\"EC2\") | .ip_prefix'"
                  eval "./$run_amz_ec2"

                  #   Privacy â€º Facebook
                  whois -h whois.radb.net -- '-i origin AS32934' | grep ^route | awk '{gsub("(route:|route6:)","");print}' | awk '{gsub(/ /,""); print}' | $GITHUB_WORKSPACE/.github/scripts/bl-template.sh 02_privacy_facebook.ipset

                  #   Privacy â€º Ahrefs
                  curl -sS -A "${{ env.USERAGENT }}" https://api.ahrefs.com/v3/public/crawler-ips | jq -r '.ips[].ip_address | select( . != null )' | $GITHUB_WORKSPACE/.github/scripts/bl-template.sh 02_privacy_ahrefs.ipset

                  #   Privacy â€º DuckDuckGo
                  curl -sS -A "${{ env.USERAGENT }}" https://raw.githubusercontent.com/duckduckgo/duckduckgo-help-pages/master/_docs/results/duckduckbot.md | grep "^\- " | awk '{gsub("-",""); print}' | awk '{gsub(/ /,""); print}' | $GITHUB_WORKSPACE/.github/scripts/bl-template.sh 02_privacy_duckduckgo.ipset

                  #   Privacy â€º Telegram
                  curl -sS -A "${{ env.USERAGENT }}" https://core.telegram.org/resources/cidr.txt | $GITHUB_WORKSPACE/.github/scripts/bl-template.sh 02_privacy_telegram.ipset

                  #   Privacy â€º Uptime Robot
                  curl -sS -A "${{ env.USERAGENT }}" https://uptimerobot.com/inc/files/ips/IPv4andIPv6.txt | $GITHUB_WORKSPACE/.github/scripts/bl-template.sh 02_privacy_uptimerobot.ipset

                  #   Privacy â€º Pingdom
                  PINGDOM_IPv4=$(curl -sS -A "${{ env.USERAGENT }}" https://my.pingdom.com/probes/ipv4)
                  PINGDOM_IPv6=$(curl -sS -A "${{ env.USERAGENT }}" https://my.pingdom.com/probes/ipv6)
                  PINGDOM_LIST="${PINGDOM_IPv4} ${PINGDOM_IPv6}"
                  echo "$PINGDOM_LIST" | .github/scripts/bl-template.sh 02_privacy_pingdom.ipset

                  #   Privacy â€º Stripe
                  curl -sS -A "${{ env.USERAGENT }}" https://stripe.com/files/ips/ips_webhooks.txt | $GITHUB_WORKSPACE/.github/scripts/bl-template.sh 02_privacy_stripe.ipset

                  #   Privacy â€º RSS API
                  curl -sS -A "${{ env.USERAGENT }}" https://rssapi.net/ips.txt | $GITHUB_WORKSPACE/.github/scripts/bl-template.sh 02_privacy_rssapi.ipset

                  #   Privacy â€º WebPageTest
                  curl -sS -A "${{ env.USERAGENT }}" https://www.webpagetest.org/addresses.php?f=json | jq -r '.data[].addresses[] | select( . != null )' | $GITHUB_WORKSPACE/.github/scripts/bl-template.sh 02_privacy_webpagetest.ipset

                  #   Privacy > Bunny CDN
                  BUNNYCDN_IPv4=$(curl -sS -A "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36" https://api.bunny.net/system/edgeserverlist/plain)
                  BUNNYCDN_IPv6=$(curl -sS -A "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36" https://api.bunny.net/system/edgeserverlist/ipv6 | jq -r '.[] | select( . != null )')
                  BUNNYCDN_LIST="${BUNNYCDN_IPv4} ${BUNNYCDN_IPv6}"
                  echo "$BUNNYCDN_LIST" | .github/scripts/bl-template.sh 02_privacy_bunnycdn.ipset

                  #   Privacy â€º Cloudflare CDN
                  CLOUDFLARE_IPv4=$(curl -sS -A "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36" https://www.cloudflare.com/ips-v4)
                  CLOUDFLARE_IPv6=$(curl -sS -A "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36" https://www.cloudflare.com/ips-v6)
                  CLOUDFLARE_LIST="${CLOUDFLARE_IPv4} ${CLOUDFLARE_IPv6}"
                  echo "$CLOUDFLARE_LIST" | .github/scripts/bl-template.sh 02_privacy_cloudflarecdn.ipset

                  #   Privacy â€º AppleBot
                  curl -sS -A "${{ env.USERAGENT }}" https://search.developer.apple.com/applebot.json | jq -r '.prefixes | .[] |.ipv4Prefix//empty,.ipv6Prefix//empty' | $GITHUB_WORKSPACE/.github/scripts/bl-template.sh 02_privacy_applebot.ipset

            # #
            #   Generate > Spam
            # #

            - name: "ðŸ§± Generate â€º Spam"
              id: task_blocklist_generate_spam
              run: |
                  run_spamhaus=".github/scripts/bl-download.sh ${{ vars.API_03_SPAM_SPAMHAUS_OUT }} false ${{ secrets.API_03_SPAM_SPAMHAUS_URL }}"
                  eval "./$run_spamhaus"

            # #
            #   Generate > Spam > Forums
            #
            #   only updated once per day (at 1am UTC)
            # #

            - name: "ðŸ§± Generate â€º Spam â€º Forums (1/day)"
              id: task_blocklist_spam_generate_forums
              if: github.event_name == 'schedule' && github.event.schedule == '0 2 * * *'
              run: |
                  chmod +x ".github/scripts/bl-download.sh"
                  run_forums=".github/scripts/bl-download.sh ${{ vars.API_03_SPAM_FORUMS_OUT }} false ${{ secrets.API_03_SPAM_FORUMS_URL }}"
                  eval "./$run_forums"

            # #
            #   Generate  > Artifact > Upload
            # #

            - name: "ðŸŽ Generate â€º Upload Artifact"
              id: task_blocklist_generate_artifact_upload
              uses: actions/upload-artifact@v4
              with:
                  name: blocklist-latest
                  path: ./blocklists
                  retention-days: 1

    # #
    #   Job > Commit
    # #

    blocklist-commit:
      name: >-
        ðŸ“‹ Commit
      runs-on: apollo-x64
      needs: [ blocklist-setup, blocklist-generate ]
      steps:

            # #
            #   Generate > Checkout
            # #

            - name: "â˜‘ï¸ Commit â€º Checkout"
              id: task_blocklist_master_checkout
              uses: actions/checkout@v4
              with:
                fetch-depth: 0

            # #
            #   Generate  > Artifact > Download
            # #

            - name: "ðŸŽ Commit â€º Download Artifact"
              id: task_commit_artifact_download
              uses: actions/download-artifact@v4
              with:
                  name: blocklist-latest
                  path: ./blocklists

            # #
            #   Commit > Precommit
            # #

            - name: "ðŸ“¦ Commit â€º Pre-commit"
              id: task_commit_pre
              run: |
                  now=$(date '+%m/%d/%Y %H:%M')
                  commit_label="Sync" >> $GITHUB_ENV
                  commit_message="\`ï¸ï¸ðŸ”’ $commit_label ðŸ”’\` \`$now\`" >> $GITHUB_ENV
                  echo "COMMIT_MESSAGE=$(echo $commit_message)" >> $GITHUB_ENV
                  echo "NOW=$(echo $now)" >> $GITHUB_ENV

            # #
            #   GPG Key
            # #

            - name: "ðŸ“¦ Commit â€º GPG Key"
              id: task_commit_gpg
              uses: crazy-max/ghaction-import-gpg@v6
              with:
                  gpg_private_key: ${{ secrets.ADMINSERV_GPG_KEY_ASC }}
                  passphrase: ${{ secrets.ADMINSERV_GPG_PASSPHRASE }}
                  git_user_signingkey: true
                  git_commit_gpgsign: true

            # #
            #   Commit > Commit
            # #

            - name: "ðŸ“¦ Commit â€º Execute"
              id: task_commit_execute
              uses: stefanzweifel/git-auto-commit-action@v5
              with:
                  commit_message: ${{ env.COMMIT_MESSAGE }}
                  commit_author: "${{ steps.task_commit_gpg.outputs.name }} <${{ steps.task_commit_gpg.outputs.email }}>"
                  commit_user_name: ${{ steps.task_commit_gpg.outputs.name }}
                  commit_user_email: ${{ steps.task_commit_gpg.outputs.email }}
